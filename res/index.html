<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <title>OpenLayers Map with TianDiTu</title>
    <link href="./ol.css" rel="stylesheet" type="text/css" />
    <style>
        .map {
            width: 100%;
            height: 100vh;
            border: 1px solid #eee;
        }
        .Bigbutton, .Smallbutton, .toggle {
            margin: 5px;
        }
        .mouse-position {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.5);
            color: white;
            padding: 5px;
            border-radius: 3px;
            font-size: 14px;
        }
        .ol-popup {
            position: absolute;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0,0,0,0.2);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #cccccc;
            bottom: 12px;
            left: -50px;
            min-width: 280px;
        }
        .ol-popup-closer {
            text-decoration: none;
            position: absolute;
            top: 2px;
            right: 8px;
            cursor: pointer;
        }
        .ol-popup-closer:after {
            content: "✖";
        }
    </style>
</head>
<body>
    <div>
        <button id="zoomIn" class="Bigbutton">放大</button>
        <button id="zoomOut" class="Smallbutton">缩小</button>
        <button id="toggleLayer" class="toggle">显示/隐藏图层</button>
        <div id="map" class="map"></div>
        <div id="mouse-position" class="mouse-position"></div>
        <div id="popup" class="ol-popup">
            <div class="ol-popup-content">
                <a href="#" class="ol-popup-closer">&times;</a>
                <p id="popupContent"></p>
            </div>
        </div>
    </div>
    <script src="./ol.js"></script>

    <script src="./qwebchannel.js" ></script>
    <script type="text/javascript">
        // 天地图key，需要替换成您自己的key
        var TianDiTuKey = 'a762f35a29dfcb0da43f31eb99269213';

        const current_path="/home/zx/桌面/DetectingScenery18";

        new QWebChannel(qt.webChannelTransport, function (channel) {
            window.showImg = channel.objects.showImg;
            window.showWidget = channel.objects.showWidget;
        });

        // 创建地图
        var map = new ol.Map({
            // 组合默认控件和其他内置控件
            controls: ol.control.defaults().extend([
                new ol.control.FullScreen(),
                //new ol.control.MousePosition(),
                new ol.control.OverviewMap(),
                new ol.control.ScaleLine(),
                new ol.control.ZoomSlider(),
                new ol.control.ZoomToExtent()
            ]),
            view: new ol.View({
                center: ol.proj.fromLonLat([118.7667, 32.0500], 'EPSG:4326', 'EPSG:3857'), // 设置南京的经纬度为中心点
                zoom: 4 // 初始缩放级别
            }),
            target: 'map'
        });

        // 添加天地图标准地图瓦片图层
        var tianDiTuLayer = new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'http://t0.tianditu.gov.cn/DataServer?T=vec_w&x={x}&y={y}&l={z}&tk=' + TianDiTuKey,
                crossOrigin: 'anonymous' // 允许跨域
            })
        });
        map.addLayer(tianDiTuLayer);

        //初始化弹窗

        var popup = new ol.Overlay({
            element: document.getElementById('popup'),
            autoPan: true,
            positioning: 'top-center',
            stopEvent: false,
            offsetX: 0,
            offsetY: -50
        });
        map.addOverlay(popup);

        var points = [
        {lon: 118.7667, lat: 32.0667, info: '南京'},
        {lon: 120.5833, lat: 31.3000, info: '苏州'},
        {lon: 120.3000, lat: 31.5667, info: '无锡'},
        {lon: 119.9500, lat: 31.7833, info: '常州'},
        {lon: 119.4500, lat: 32.2000, info: '镇江'},
        {lon: 119.4500, lat: 25.4000},
        {lon: 120.1000, lat: 23.0000},
        ];

        // 创建矢量图层
        var vectorLayer = new ol.layer.Vector({
            source: new ol.source.Vector({
                features: points.map(function(point) {
                    var feature = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.fromLonLat([point.lon, point.lat])),
                        name: point.info, // 存储点位信息
                        pointId: points.indexOf(point) // 点位ID，用于区分不同的点
                    });
                    if(point.info){
                        // 设置默认样式
                        feature.setStyle(new ol.style.Style({
                            image: new ol.style.Icon({
                                src: './location.png', // 标记图标路径
                                size: [32, 32],
                                scale: 0.5
                            }),
                            fill: new ol.style.Fill({
                                color: 'rgba(255, 255, 0, 0.5)' // 默认高亮样式
                            }),
                            stroke: new ol.style.Stroke({
                                color: '#ffcc33', // 轮廓颜色
                                width: 2 // 轮廓宽度
                            })
                        }));
                    }else{
                        feature.setStyle(new ol.style.Style({
                            image: new ol.style.Icon({
                            src: './temp.png',
                            // scale: 0.5, // 图标缩放比例
                            // 设置size属性来指定图标大小
                            // 跨域
                            // crossOrigin: 'anonymous',
                            size: [32, 32]
                            })
                        }));
                    }
                    return feature;
                })
            })
        });
        map.addLayer(vectorLayer);
        
        


        // 地图初始化完成后，添加鼠标移动事件监听器
        map.on('pointermove', function(event) {
            var coordinate = event.coordinate;
            document.getElementById('mouse-position').innerHTML =
                `经度: ${ol.proj.toLonLat(coordinate)[0].toFixed(2)}, 纬度: ${ol.proj.toLonLat(coordinate)[1].toFixed(2)}`;
        });


        // 地图点击事件，显示弹窗
        map.on('click', function(event) {
            var feature = map.forEachFeatureAtPixel(event.pixel, function(feature) {
                return feature;
            });
            if (feature) {
                // 获取点位信息
                var info = feature.get('name');
                var coordinate = event.coordinate;
                var content = document.getElementById('popupContent');
                content.innerHTML = info || '未知';
                // 设置弹窗位置并显示
                popup.setPosition(coordinate);
                document.getElementById('popup').style.display = 'block';
                if(info){
                    // 调用qt的槽函数
                    window.showWidget.init();
                }else{
                    // 调用qt的槽函数
                    var ico_src=current_path+"/res/pic1.jpg";
                    window.showImg.showDialog(ico_src);
                }
            } else {
                document.getElementById('popup').style.display = 'none';
            }
        });

        // ... 其他按钮事件监听代码 ...
    </script>
</body>
</html>
