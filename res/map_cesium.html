<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cesium 3D Map</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.95/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html,
        body,
        #cesiumContainer {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        .platform-marker {
            background-color: blue;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
            position: relative;
        }

        .target-marker {
            background-color: red;
            border-radius: 50%;
            border: 2px solid white;
            cursor: pointer;
        }

        .cesium-infoBox {
            max-width: 300px;
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    <script>
        // 初始化Cesium访问令牌（如果需要）
        // Cesium.Ion.defaultAccessToken = 'your_access_token_here';

        // 全局变量
        var viewer;
        var platformEntities = [];
        var targetEntities = [];
        var lineEntities = [];
        var errorEllipseEntities = [];

        // 初始化地图
        function initMap() {
            viewer = new Cesium.Viewer('cesiumContainer', {
                imageryProvider: new Cesium.OpenStreetMapImageryProvider({
                    url: 'https://a.tile.openstreetmap.org/'
                }),
                baseLayerPicker: false,
                timeline: false,
                animation: false,
                vrButton: false,
                geocoder: true,
                homeButton: true,
                infoBox: true,
                sceneModePicker: true,
                selectionIndicator: true,
                navigationHelpButton: true
            });
            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(116.3833, 39.9167, 1000000)
            });
            viewer.cesiumWidget.creditContainer.style.display = "none";
        }
        document.addEventListener('DOMContentLoaded', initMap);

        // 添加平台（雷达）
        function addPlatform(lat, lon, name) {
            var entity = viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(lon, lat),
                name: name,
                billboard: {
                    image: 'location.png',
                    width: 24,
                    height: 24,
                    verticalOrigin: Cesium.VerticalOrigin.CENTER,
                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER
                },
                label: {
                    text: name,
                    font: '14px sans-serif',
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    outlineWidth: 2,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -10)
                },
                properties: {
                    type: 'platform',
                    lat: lat,
                    lon: lon
                }
            });

            platformEntities.push(entity);
            return entity;
        }

        // 添加目标
        function addTarget(lat, lon, name = "目标") {
            var entity = viewer.entities.add({
                position: Cesium.Cartesian3.fromDegrees(lon, lat),
                name: name,
                billboard: {
                    image: 'temp.png',
                    width: 20,
                    height: 20,
                    verticalOrigin: Cesium.VerticalOrigin.CENTER,
                    horizontalOrigin: Cesium.HorizontalOrigin.CENTER
                },
                label: {
                    text: name,
                    font: '14px sans-serif',
                    style: Cesium.LabelStyle.FILL_AND_OUTLINE,
                    outlineWidth: 2,
                    verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                    pixelOffset: new Cesium.Cartesian2(0, -10)
                },
                properties: {
                    type: 'target',
                    lat: lat,
                    lon: lon
                }
            });

            targetEntities.push(entity);
            return entity;
        }

        // 添加方位线
        function addLineOfBearing(platformLat, platformLon, azimuth, length, color) {
            // 计算终点坐标
            var radAzimuth = (azimuth * Math.PI) / 180;
            var lon2 = platformLon + (length * Math.sin(radAzimuth)) / (111.32 * Math.cos(platformLat * Math.PI / 180));
            var lat2 = platformLat + (length * Math.cos(radAzimuth)) / 111.32;

            var entity = viewer.entities.add({
                polyline: {
                    positions: Cesium.Cartesian3.fromDegreesArray([
                        platformLon, platformLat,
                        lon2, lat2
                    ]),
                    width: 2,
                    material: new Cesium.ColorMaterialProperty(
                        Cesium.Color.fromCssColorString(color || 'blue')
                    )
                }
            });

            lineEntities.push(entity);
            return entity;
        }

        // 添加误差椭圆
        function addErrorEllipse(centerLat, centerLon, semiMajorAxis, semiMinorAxis, orientation, color, fillColor) {
            // 生成椭圆点
            var positions = [];
            var points = 60;  // 椭圆边缘的点数量

            for (var i = 0; i <= points; i++) {
                var angle = (i * 2 * Math.PI) / points;

                // 椭圆参数方程
                var x = semiMajorAxis * Math.cos(angle);
                var y = semiMinorAxis * Math.sin(angle);

                // 旋转
                var rotX = x * Math.cos(orientation) - y * Math.sin(orientation);
                var rotY = x * Math.sin(orientation) + y * Math.cos(orientation);

                // 转换为经纬度
                var latDelta = rotY / 111.32;  // 每度纬度大约111.32公里
                var lonDelta = rotX / (111.32 * Math.cos(centerLat * Math.PI / 180));

                var lon = centerLon + lonDelta;
                var lat = centerLat + latDelta;

                positions.push(lon, lat);
            }

            var entity = viewer.entities.add({
                polygon: {
                    hierarchy: Cesium.Cartesian3.fromDegreesArray(positions),
                    material: new Cesium.ColorMaterialProperty(
                        Cesium.Color.fromCssColorString(fillColor || 'rgba(255, 0, 0, 0.2)')
                    ),
                    outline: true,
                    outlineColor: Cesium.Color.fromCssColorString(color || 'rgba(255, 0, 0, 0.8)')
                }
            });

            errorEllipseEntities.push(entity);
            return entity;
        }

        // 清除所有图层
        function clearAllLayers() {
            // 清除所有实体
            platformEntities.forEach(entity => viewer.entities.remove(entity));
            targetEntities.forEach(entity => viewer.entities.remove(entity));
            lineEntities.forEach(entity => viewer.entities.remove(entity));
            errorEllipseEntities.forEach(entity => viewer.entities.remove(entity));

            // 清空数组
            platformEntities = [];
            targetEntities = [];
            lineEntities = [];
            errorEllipseEntities = [];
        }

        // 定位到指定位置
        function centerMap(lat, lon, height) {
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(lon, lat, height || 100000),
                duration: 1.0
            });
        }

        // 设置地图类型
        function setMapType(type) {
            if (type === '3d') {
                viewer.scene.morphTo3D();
            } else if (type === '2d') {
                viewer.scene.morphTo2D();
            } else if (type === 'columbus') {
                viewer.scene.morphToColumbusView();
            }
        }

        // 初始化地图
        document.addEventListener('DOMContentLoaded', initMap);

        // 提供接口给外部调用
        window.addPoint = function (longitude, latitude, info) {
            if (info && info.includes('雷达')) {
                return addPlatform(latitude, longitude, info);
            } else {
                return addTarget(latitude, longitude, info);
            }
        };

        window.addPoints = function (points) {
            points.forEach(point => {
                window.addPoint(point.longitude, point.latitude, point.info);
            });
        };

        window.clearPoints = function () {
            clearAllLayers();
        };

        window.setCenter = function (longitude, latitude, zoomLevel) {
            // 将缩放级别转换为高度
            var height = 10000000 / Math.pow(2, zoomLevel);
            centerMap(latitude, longitude, height);
        };

        window.setMapType = function (type) {
            setMapType(type);
        };
    </script>
</body>

</html>